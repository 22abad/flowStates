<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flow Log | flowstates.me</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Noto+Serif+SC:wght@300;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root{--bg:#0f172a;--muted:#94a3b8}
        body { background-color: var(--bg); color: #e2e8f0; overflow-x: hidden; }
        .font-serif-en { font-family: 'Lora', serif; }
        .font-serif-cn { font-family: 'Noto Serif SC', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        #flowCanvas { position: fixed; inset:0; width:100%; height:100%; z-index:-1; opacity:0.6; }
        .fade-in { animation: fadeIn 1s ease-out both; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }

        /* --- Markdown Typography Improvements --- */
        .prose { font-size: 1.125rem; line-height: 1.9; } /* Larger text, breathable line height */
        
        /* Hide duplicate H1 if it exists in markdown */
        .prose h1:first-child { display: none; } 
        
        .prose h1, .prose h2, .prose h3 { color: #f1f5f9; margin-top: 2.5em; margin-bottom: 0.8em; font-weight: 600; letter-spacing: -0.02em; }
        .prose h1 { font-size: 2.25em; }
        .prose h2 { font-size: 1.75em; border-bottom: 1px solid #334155; padding-bottom: 0.3em; color: #ccfbf1; }
        .prose h3 { font-size: 1.4em; color: #99f6e4; }
        
        .prose p { margin-bottom: 1.5em; opacity: 0.9; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1.5em; color: #cbd5e1; }
        
        /* Stylized Blockquote */
        .prose blockquote { 
            border-left: 4px solid #2dd4bf; 
            background: rgba(30, 41, 59, 0.5);
            padding: 1rem 1.5rem; 
            margin: 2rem 0;
            border-radius: 0 8px 8px 0;
            font-style: italic; 
            color: #e2e8f0;
        }
        
        .prose code { background: #1e293b; padding: 0.2em 0.4em; rounded: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #5eead4; border: 1px solid #334155; }
        .prose pre { background: #020617; padding: 1.5em; overflow-x: auto; border-radius: 8px; margin-bottom: 2em; border: 1px solid #1e293b; }
        .prose pre code { background: transparent; padding: 0; border: none; color: inherit; }
        .prose strong { color: #fff; font-weight: 700; }
        .prose a { color: #5eead4; text-decoration: underline; text-decoration-color: #2dd4bf; text-underline-offset: 3px; }
        .prose a:hover { color: #fff; }

        /* Tag/Badge Styles */
        .cat-badge { 
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em;
            background: rgba(45, 212, 191, 0.1); border: 1px solid rgba(45, 212, 191, 0.3);
            color: #5eead4; padding: 0.3rem 0.8rem; border-radius: 999px;
        }
        .tag-pill { 
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;
            border: 1px solid #475569; color: #94a3b8; padding: 0.2rem 0.6rem; border-radius: 4px;
        }
    </style>
</head>
<body class="antialiased selection:bg-teal-500 selection:text-white">

<canvas id="flowCanvas" aria-hidden="true"></canvas>

<nav class="fixed top-0 w-full p-6 flex justify-between items-center z-50 backdrop-blur-md bg-slate-900/60 border-b border-slate-800/50">
    <a href="index.html" class="group text-lg font-bold tracking-widest opacity-90 hover:text-teal-300 transition flex items-center gap-2">
        <span class="group-hover:-translate-x-1 transition-transform duration-300">←</span> BACK
    </a>
    <button id="langToggle" class="px-4 py-1 border border-slate-500 rounded-full text-xs hover:bg-teal-900/50 hover:border-teal-400 transition uppercase tracking-wide">SWITCH TO 中文</button>
</nav>

<main class="min-h-screen max-w-3xl mx-auto px-6 py-32 relative z-10">
    
    <header class="fade-in mb-12 pb-8 border-b border-slate-800">
        <div class="flex flex-wrap items-center gap-4 mb-6">
            <span id="post-date" class="text-xs font-mono text-slate-500 uppercase tracking-widest">Loading...</span>
            <div id="post-cats" class="flex gap-2"></div>
        </div>
        
        <h1 class="text-3xl sm:text-5xl font-bold text-slate-100 leading-tight mb-6">
            <span id="title-en" class="content-en font-serif-en block"></span>
            <span id="title-zh" class="content-zh hidden font-serif-cn block mt-2 opacity-90"></span>
        </h1>

        <div id="post-tags" class="flex flex-wrap gap-2 opacity-80"></div>
    </header>

    <article id="post-body" class="prose fade-in font-serif-en text-slate-300">
        <div class="text-center opacity-50 italic py-20">Retrieving content...</div>
    </article>

</main>

<script>
(function(){
    // CONFIG
    const GITHUB_USERNAME = '22abad';
    const GITHUB_REPO = 'flowStates';
    const POSTS_FOLDER = 'posts';

    const toggleBtn = document.getElementById('langToggle');
    let isEnglish = true;
    function updateLang() {
        document.querySelectorAll('.content-en').forEach(el => el.classList.toggle('hidden', !isEnglish));
        document.querySelectorAll('.content-zh').forEach(el => el.classList.toggle('hidden', isEnglish));
        toggleBtn.textContent = isEnglish ? 'SWITCH TO 中文' : 'SWITCH TO ENGLISH';
    }
    toggleBtn.addEventListener('click', ()=>{ isEnglish = !isEnglish; updateLang(); });

    function getQueryParam(name) { return new URLSearchParams(window.location.search).get(name); }

    function parseFrontMatter(raw){
        const result = {meta:{}, body: raw};
        const m = raw.match(/^---\s*([\s\S]*?)\s*---\s*/);
        if(!m) return result;
        const head = m[1]; const lines = head.split(/\r?\n/); let currentKey = null;
        lines.forEach(line => {
            if(!line.trim()) return;
            if(line.trim().startsWith('-') && currentKey) {
                let val = line.trim().replace(/^-\s*/, '').trim();
                if(/^['"].*['"]$/.test(val)) val = val.slice(1,-1);
                if(!Array.isArray(result.meta[currentKey])) result.meta[currentKey] = [];
                result.meta[currentKey].push(val);
            } else if(line.includes(':')) {
                const idx = line.indexOf(':'); const key = line.slice(0, idx).trim(); let val = line.slice(idx+1).trim(); currentKey = key;
                if(val) { if(/^['"].*['"]$/.test(val)) val = val.slice(1,-1); result.meta[key] = val; } else { result.meta[key] = []; }
            }
        });
        result.body = raw.slice(m[0].length); return result;
    }

    function renderBodyContent(rawBody) {
        const enMatch = rawBody.match(/\[EN\]([\s\S]*?)\[END\]/);
        const zhMatch = rawBody.match(/\[ZH\]([\s\S]*?)\[END\]/);
        let html = '';
        if(enMatch) html += `<div class="content-en">${marked.parse(enMatch[1])}</div>`;
        else if(!zhMatch) html += `<div class="content-en">${marked.parse(rawBody)}</div>`;
        if(zhMatch) html += `<div class="content-zh hidden font-serif-cn">${marked.parse(zhMatch[1])}</div>`;
        document.getElementById('post-body').innerHTML = html;
    }

    async function loadPost(){
        const filename = getQueryParam('id');
        if(!filename) { window.location.href = 'index.html'; return; }

        try {
            const fileUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${POSTS_FOLDER}/${decodeURIComponent(filename)}.md`;
            const res = await fetch(fileUrl);
            if(!res.ok) throw new Error('Post not found');
            const text = await res.text();
            
            const data = parseFrontMatter(text);
            const meta = data.meta;

            // 1. Titles & Date
            document.title = (meta.title_en || meta.title) + ' | Flow States';
            document.getElementById('title-en').textContent = meta.title_en || meta.title;
            document.getElementById('title-zh').textContent = meta.title_zh || meta.title_en;
            document.getElementById('post-date').textContent = meta.date || '';

            // 2. Categories (Badges)
            const catsContainer = document.getElementById('post-cats');
            const cats = Array.isArray(meta.categories) ? meta.categories : (meta.categories ? [meta.categories] : []);
            cats.forEach(c => {
                const span = document.createElement('span');
                span.className = 'cat-badge';
                span.textContent = c;
                catsContainer.appendChild(span);
            });

            // 3. Tags
            const tagsContainer = document.getElementById('post-tags');
            const tags = Array.isArray(meta.tags) ? meta.tags : (meta.tags ? [meta.tags] : []);
            tags.forEach(t => {
                const span = document.createElement('span');
                span.className = 'tag-pill';
                span.textContent = '#' + t;
                tagsContainer.appendChild(span);
            });

            // 4. Render Body
            renderBodyContent(data.body);
            updateLang();

        } catch(e) {
            console.error(e);
            document.getElementById('post-body').innerHTML = `<div class="text-red-400 py-10 text-center">Error loading post. <br><a href="index.html" class="underline mt-4 inline-block">Return home</a></div>`;
        }
    }

    const canvas = document.getElementById('flowCanvas');
    const ctx = canvas.getContext && canvas.getContext('2d');
    let w,h,particles=[];
    function resize(){ if(!canvas) return; w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
    function anim(){ if(!ctx) return; ctx.clearRect(0,0,w,h); particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0) p.x=w; if(p.x>w) p.x=0; if(p.y<0) p.y=h; if(p.y>h) p.y=0; ctx.fillStyle='rgba(94,234,212,0.12)'; ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(anim); }
    if(ctx){ window.addEventListener('resize',resize); resize(); for(let i=0;i<40;i++) particles.push({x:Math.random()* (window.innerWidth||800), y:Math.random()* (window.innerHeight||600), vx:(Math.random()-0.5)*0.3, vy:(Math.random()-0.5)*0.3, s:Math.random()*2}); anim(); }

    loadPost();
})();
</script>
</body>
</html>

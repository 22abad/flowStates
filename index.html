<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flow States | flowstates.me</title>
    <meta name="description" content="Personal logs and essays." />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Noto+Serif+SC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root{--bg:#0f172a;--muted:#94a3b8}
        body { background-color: var(--bg); color: #e2e8f0; overflow-x: hidden; font-family: 'Inter', system-ui, sans-serif; }
        .font-serif-en { font-family: 'Lora', serif; }
        .font-serif-cn { font-family: 'Noto Serif SC', serif; }
        
        /* 动效背景 */
        #flowCanvas { position: fixed; inset:0; width:100%; height:100%; z-index:-1; opacity:0.6; pointer-events: none;}
        .fade-in { animation: fadeIn 1.0s ease-out both; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(15px)} to{opacity:1; transform:none} }
        
        /* 交互样式 */
        .post-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .post-card:hover { transform: translateY(-2px); background-color: rgba(30, 41, 59, 0.6); }
        
        .tag-pill { transition: all 0.2s; }
        .tag-pill:hover { transform: scale(1.05); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="antialiased selection:bg-teal-500 selection:text-white">

<canvas id="flowCanvas" aria-hidden="true"></canvas>

<nav class="fixed top-0 w-full p-6 flex justify-between items-center z-50 backdrop-blur-md bg-slate-900/40 border-b border-white/5">
    <div class="text-lg font-bold tracking-[0.15em] text-teal-400 hover:text-teal-300 transition cursor-pointer" onclick="window.location.reload()">
        FLOWSTATES.ME
    </div>
    <button id="langToggle" class="px-4 py-1.5 border border-slate-600 rounded-full text-[10px] font-bold tracking-widest hover:border-teal-400 hover:text-teal-400 transition uppercase">
        Switch to 中文
    </button>
</nav>

<main class="min-h-screen flex flex-col items-center pt-32 pb-20 px-4 relative z-10">
    
    <header class="max-w-2xl w-full fade-in text-center mb-16">
        <h1 class="text-5xl sm:text-6xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-br from-teal-200 via-slate-200 to-teal-400">
            <span class="content-en font-serif-en">Flow States</span>
            <span class="content-zh hidden font-serif-cn">心流时刻</span>
        </h1>
        <div class="space-y-4 text-lg sm:text-xl text-slate-400 font-light max-w-lg mx-auto leading-relaxed">
            <p class="content-en font-serif-en italic">A digital garden capturing moments of clarity.</p>
            <p class="content-zh hidden font-serif-cn">捕捉那些绝对清醒与创造力的稍纵即逝。</p>
        </div>
    </header>

    <section class="max-w-2xl w-full fade-in mb-4 flex justify-between items-end border-b border-slate-800 pb-2">
        <h2 class="text-xs uppercase tracking-[0.2em] text-teal-500 font-bold">
            <span class="content-en">Latest Logs</span>
            <span class="content-zh hidden">最新日志</span>
        </h2>
        
        <div id="filter-indicator" class="hidden text-xs flex items-center gap-2 animate-pulse">
            <span class="opacity-50">Filter:</span>
            <span id="active-filter-name" class="text-teal-300 font-bold"></span>
            <button onclick="clearFilter()" class="text-slate-500 hover:text-red-400 ml-1 transition" title="Clear">✕</button>
        </div>
    </section>

    <div id="post-list" class="max-w-2xl w-full space-y-4 fade-in">
        <div class="text-center py-12 opacity-50 text-sm font-mono animate-pulse">
            Connecting to memory...
        </div>
    </div>

</main>

<footer class="fixed bottom-6 w-full text-center opacity-30 text-[10px] uppercase tracking-[0.3em] pointer-events-none mix-blend-screen">
    22abad · flow log
</footer>

<script>
// --- CONFIGURATION ---
const GITHUB_USERNAME = '22abad';
const GITHUB_REPO = 'flowStates';
const POSTS_FOLDER = 'posts';

// --- STATE ---
let ALL_POSTS = [];
let isEnglish = true;

// --- DOM ELEMENTS ---
const toggleBtn = document.getElementById('langToggle');
const postListEl = document.getElementById('post-list');

// --- I18N LOGIC ---
function updateLang() {
    document.querySelectorAll('.content-en').forEach(el => el.classList.toggle('hidden', !isEnglish));
    document.querySelectorAll('.content-zh').forEach(el => el.classList.toggle('hidden', isEnglish));
    toggleBtn.textContent = isEnglish ? 'SWITCH TO 中文' : 'SWITCH TO ENGLISH';
}
toggleBtn.addEventListener('click', () => { isEnglish = !isEnglish; updateLang(); });

// --- PARSING LOGIC (更强壮的 FrontMatter 解析) ---
function parseFrontMatter(text) {
    const meta = {};
    const pattern = /^---\s*([\s\S]*?)\s*---/;
    const match = text.match(pattern);
    
    if (!match) return { meta: { title: 'Untitled' }, body: text };

    const rawMeta = match[1];
    const lines = rawMeta.split(/\r?\n/);
    
    let currentKey = null;

    lines.forEach(line => {
        if (!line.trim() || line.trim().startsWith('#')) return;

        // 1. Array item: "  - value"
        if (line.trim().startsWith('-') && currentKey) {
            let val = line.trim().replace(/^-\s*/, '').replace(/^['"](.*)['"]$/, '$1');
            if (!Array.isArray(meta[currentKey])) meta[currentKey] = [];
            meta[currentKey].push(val);
        }
        // 2. Key-Value: "key: value" or "key: [a, b]"
        else if (line.includes(':')) {
            const [key, ...rest] = line.split(':');
            const cleanKey = key.trim();
            let val = rest.join(':').trim(); // handle colons in value

            // Check for inline array: [tag1, tag2]
            if (val.startsWith('[') && val.endsWith(']')) {
                meta[cleanKey] = val.slice(1, -1).split(',').map(s => s.trim().replace(/^['"](.*)['"]$/, '$1'));
                currentKey = null; // Reset because inline array is complete
            } else if (val === '') {
                // Empty value implies start of a list on next lines
                currentKey = cleanKey;
                meta[cleanKey] = [];
            } else {
                // Standard string value
                meta[cleanKey] = val.replace(/^['"](.*)['"]$/, '$1');
                currentKey = null;
            }
        }
    });

    return { meta, body: text.slice(match[0].length) };
}

// --- FILTERING ---
window.filterPosts = function(tag) {
    const filtered = ALL_POSTS.filter(p => {
        const cats = Array.isArray(p.categories) ? p.categories : (p.categories ? [p.categories] : []);
        const tags = Array.isArray(p.tags) ? p.tags : (p.tags ? [p.tags] : []);
        return cats.includes(tag) || tags.includes(tag);
    });

    document.getElementById('filter-indicator').classList.remove('hidden');
    document.getElementById('active-filter-name').textContent = tag;
    renderPosts(filtered);
}

window.clearFilter = function() {
    document.getElementById('filter-indicator').classList.add('hidden');
    renderPosts(ALL_POSTS);
}

// --- RENDERING ---
function renderPosts(posts) {
    postListEl.innerHTML = '';

    if (posts.length === 0) {
        postListEl.innerHTML = '<div class="text-center opacity-40 py-10 italic">No logs found.</div>';
        return;
    }

    posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'post-card relative bg-slate-800/20 border border-slate-700/50 rounded-lg p-6 mb-4 overflow-hidden group';

        // 1. Link (Overlay)
        const link = document.createElement('a');
        // Encoded ID
        link.href = `post.html?id=${encodeURIComponent(post.filename.replace(/\.md$/i, ''))}`;
        link.className = 'absolute inset-0 z-0';
        card.appendChild(link);

        // 2. Header: Title + Date
        const header = document.createElement('div');
        header.className = 'flex flex-col sm:flex-row sm:justify-between sm:items-baseline gap-2 mb-3 relative z-10 pointer-events-none';
        
        // Title
        const titleH3 = document.createElement('h3');
        titleH3.className = 'text-xl font-bold text-slate-100 group-hover:text-teal-300 transition-colors font-serif-en';
        
        const enSpan = document.createElement('span'); enSpan.className = 'content-en'; enSpan.textContent = post.title_en;
        const zhSpan = document.createElement('span'); zhSpan.className = 'content-zh hidden font-serif-cn'; zhSpan.textContent = post.title_zh || post.title_en;
        
        titleH3.appendChild(enSpan);
        titleH3.appendChild(zhSpan);

        // Date
        const dateSpan = document.createElement('span');
        dateSpan.className = 'text-xs font-mono text-slate-500 whitespace-nowrap';
        dateSpan.textContent = post.date;

        header.appendChild(titleH3);
        header.appendChild(dateSpan);
        card.appendChild(header);

        // 3. Summary
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'text-sm text-slate-400 font-light leading-relaxed mb-4 relative z-10 pointer-events-none';
        
        const sumEn = document.createElement('span'); sumEn.className = 'content-en'; sumEn.textContent = post.summary_en;
        const sumZh = document.createElement('span'); sumZh.className = 'content-zh hidden'; sumZh.textContent = post.summary_zh || post.summary_en;
        
        summaryDiv.appendChild(sumEn);
        summaryDiv.appendChild(sumZh);
        card.appendChild(summaryDiv);

        // 4. Tags (Interactive)
        const tagRow = document.createElement('div');
        tagRow.className = 'flex flex-wrap gap-2 relative z-20'; // z-20 to be clickable above link

        const allTags = [
            ...(Array.isArray(post.categories) ? post.categories : [post.categories]),
            ...(Array.isArray(post.tags) ? post.tags : [post.tags])
        ].filter(Boolean); // remove nulls/undefined

        // Deduplicate
        const uniqueTags = [...new Set(allTags)];

        uniqueTags.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'tag-pill text-[10px] px-2 py-0.5 border border-slate-700 text-slate-400 hover:text-teal-300 hover:border-teal-500/50 rounded bg-slate-900/30 uppercase tracking-wide cursor-pointer';
            btn.textContent = t;
            btn.onclick = (e) => {
                e.stopPropagation(); // Prevent card click
                e.preventDefault();
                window.filterPosts(t);
            };
            tagRow.appendChild(btn);
        });

        if (uniqueTags.length > 0) card.appendChild(tagRow);

        postListEl.appendChild(card);
    });

    updateLang();
}

// --- DATA FETCHING ---
async function loadData() {
    try {
        // 1. Get List of Files
        const repoUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${POSTS_FOLDER}`;
        const res = await fetch(repoUrl);
        
        if (!res.ok) {
            if(res.status === 403) throw new Error("API Rate Limit Exceeded. Please wait.");
            if(res.status === 404) throw new Error("Repo or folder not found.");
            throw new Error(`GitHub Error: ${res.status}`);
        }
        
        const files = await res.json();
        const mdFiles = files.filter(f => f.name.endsWith('.md'));

        // 2. Fetch Content for each file
        ALL_POSTS = await Promise.all(mdFiles.map(async file => {
            try {
                const contentRes = await fetch(file.download_url);
                const text = await contentRes.text();
                const { meta } = parseFrontMatter(text);

                return {
                    filename: file.name,
                    title_en: meta.title_en || meta.title || file.name,
                    title_zh: meta.title_zh || '',
                    date: meta.date || '',
                    summary_en: meta.summary_en || meta.summary || 'No summary.',
                    summary_zh: meta.summary_zh || '',
                    tags: meta.tags || [],
                    categories: meta.categories || []
                };
            } catch (err) {
                console.warn('Failed to load post:', file.name, err);
                return null;
            }
        }));

        // 3. Clean and Sort
        ALL_POSTS = ALL_POSTS.filter(p => p !== null);
        ALL_POSTS.sort((a, b) => {
            const dateA = new Date(a.date).getTime() || 0;
            const dateB = new Date(b.date).getTime() || 0;
            return dateB - dateA;
        });

        renderPosts(ALL_POSTS);

    } catch (err) {
        console.error(err);
        postListEl.innerHTML = `
            <div class="text-center text-red-400/80 mt-10">
                <p class="text-lg">Unable to load logs.</p>
                <p class="text-xs font-mono mt-2 opacity-60">${err.message}</p>
            </div>
        `;
    }
}

// --- CANVAS ANIMATION ---
const canvas = document.getElementById('flowCanvas');
const ctx = canvas && canvas.getContext('2d');
if (ctx) {
    let w, h, particles = [];
    const resize = () => { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; };
    window.addEventListener('resize', resize);
    resize();
    
    // Init particles
    for(let i=0; i<35; i++){
        particles.push({
            x: Math.random() * w, 
            y: Math.random() * h, 
            vx: (Math.random() - 0.5) * 0.4, 
            vy: (Math.random() - 0.5) * 0.4, 
            size: Math.random() * 2
        });
    }

    function animate() {
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = 'rgba(94, 234, 212, 0.15)'; // Teal tint
        
        particles.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0) p.x = w; if (p.x > w) p.x = 0;
            if (p.y < 0) p.y = h; if (p.y > h) p.y = 0;
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
        });
        requestAnimationFrame(animate);
    }
    animate();
}

// Start
loadData();

</script>
</body>
</html>
